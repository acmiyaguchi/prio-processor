import sys
import click


def common_options(func):
    options = [
        click.option(
            "--server-id",
            required=True,
            type=click.Choice(["A", "B"]),
            help="The identifier for match.",
        ),
        click.option(
            "--public-key-internal",
            required=True,
            type=bytes,
            help="The public key of the processing server.",
        ),
        click.option(
            "--public-key-external",
            required=True,
            type=bytes,
            help="The public key of the co-processing server.",
        ),
        click.option(
            "--private-key",
            required=True,
            type=bytes,
            help="The private key of the processing server.",
        ),
        click.option(
            "--output",
            required=True,
            type=click.Path(file_okay=False),
            help="The path to the output directory.",
        ),
    ]
    for option in options:
        func = option(func)
    return func


def input_internal_option(func):
    return click.option(
        "--input-internal",
        required=True,
        type=click.Path(file_okay=False),
        help="Directory containing data generated by the processing server.",
    )(func)


def input_external_option(func):
    return click.option(
        "--input-external",
        required=True,
        type=click.Path(file_okay=False),
        help="Directory containing data generated by the co-processing server.",
    )(func)


@click.command()
@common_options
@input_internal_option
def verify1():
    """Decode a batch of shares"""
    click.echo("Running verify1")


@click.command()
@common_options
@input_internal_option
@input_external_option
def verify2():
    """Verify a batch of SNIPs"""
    click.echo("Running verify2")


@click.command()
@common_options
@input_internal_option
@input_external_option
def aggregate():
    """Generate an aggregate share from a batch of verified SNIPs"""
    click.echo("Running aggregate")


@click.command()
@common_options
@input_internal_option
@input_external_option
def publish():
    """Generate a final aggregate and remap data to a content blocklist"""
    click.echo("Running publish")


@click.group()
def main(args=None):
    """Command line utility for prio."""
    pass


main.add_command(verify1)
main.add_command(verify2)
main.add_command(aggregate)
main.add_command(publish)

if __name__ == "__main__":
    sys.exit(main())
