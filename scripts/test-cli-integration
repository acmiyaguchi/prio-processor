#!/bin/bash

set -eou pipefail
set -x

cd "$(dirname "$0")/.."

key_a=$(prio keygen)
key_b=$(prio keygen)
shared=$(prio shared-seed)

###########################################################
# encode-shares
###########################################################

mkdir -p working/client

cat << EOF > working/client/data.ndjson
[1, 0, 0]
[1, 1, 0]
[1, 1, 1]
EOF

jq -c '.' working/client/data.ndjson

python -m prio encode-shares \
    --n-data 3 \
    --batch-id test \
    --public-key-internal $(jq -r ".public_key" <<< $key_a) \
    --public-key-external $(jq -r ".public_key" <<< $key_b) \
    --input working/client/data.ndjson \
    --output-A working/server_a/raw/ \
    --output-B working/server_b/raw/

jq -c '.' working/server_a/raw/data.ndjson
jq -c '.' working/server_b/raw/data.ndjson

###########################################################
# verify1
###########################################################

python -m prio verify1 \
    --n-data 3 \
    --batch-id test \
    --server-id A \
    --private-key $(jq -r ".private_key" <<< $key_a) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_a) \
    --public-key-external $(jq -r ".public_key" <<< $key_b) \
    --input working/server_a/raw/data.ndjson \
    --output working/server_a/intermediate/internal/verify1

jq -c '.' working/server_a/intermediate/internal/verify1/data.ndjson

cp \
    working/server_a/intermediate/internal/verify1/data.ndjson \
    working/server_b/intermediate/external/verify1/

python -m prio verify1 \
    --n-data 3 \
    --batch-id test \
    --server-id B \
    --private-key $(jq -r ".private_key" <<< $key_b) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_b) \
    --public-key-external $(jq -r ".public_key" <<< $key_a) \
    --input working/server_b/raw/data.ndjson \
    --output working/server_b/intermediate/internal/verify1

jq -c '.' working/server_b/intermediate/internal/verify1/data.ndjson

cp \
    working/server_b/intermediate/internal/verify1/data.ndjson \
    working/server_a/intermediate/external/verify1/

###########################################################
# verify2
###########################################################

python -m prio verify2 \
    --n-data 3 \
    --batch-id test \
    --server-id A \
    --private-key $(jq -r ".private_key" <<< $key_a) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_a) \
    --public-key-external $(jq -r ".public_key" <<< $key_b) \
    --input working/server_a/raw/data.ndjson \
    --input-internal working/server_a/intermediate/internal/verify1/data.ndjson \
    --input-external working/server_a/intermediate/external/verify1/data.ndjson \
    --output working/server_a/intermediate/internal/verify2/ \

jq -c '.' working/server_a/intermediate/internal/verify2/data.ndjson

cp \
    working/server_a/intermediate/internal/verify2/data.ndjson \
    working/server_b/intermediate/external/verify2/

python -m prio verify2 \
    --n-data 3 \
    --batch-id test \
    --server-id B \
    --private-key $(jq -r ".private_key" <<< $key_b) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_b) \
    --public-key-external $(jq -r ".public_key" <<< $key_a) \
    --input working/server_b/raw/data.ndjson \
    --input-internal working/server_b/intermediate/internal/verify1/data.ndjson \
    --input-external working/server_b/intermediate/external/verify1/data.ndjson \
    --output working/server_b/intermediate/internal/verify2/ \

jq -c '.' working/server_b/intermediate/internal/verify2/data.ndjson

cp \
    working/server_b/intermediate/internal/verify2/data.ndjson \
    working/server_a/intermediate/external/verify2/

###########################################################
# aggregate
###########################################################

python -m prio aggregate \
    --n-data 3 \
    --batch-id test \
    --server-id A \
    --private-key $(jq -r ".private_key" <<< $key_a) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_a) \
    --public-key-external $(jq -r ".public_key" <<< $key_b) \
    --input working/server_a/raw/data.ndjson \
    --input-internal working/server_a/intermediate/internal/verify2/data.ndjson \
    --input-external working/server_a/intermediate/external/verify2/data.ndjson \
    --output working/server_a/intermediate/internal/aggregate/

jq -c '.' working/server_a/intermediate/internal/aggregate/data.ndjson

cp \
    working/server_a/intermediate/internal/aggregate/data.ndjson \
    working/server_b/intermediate/external/aggregate/

python -m prio aggregate \
    --n-data 3 \
    --batch-id test \
    --server-id B \
    --private-key $(jq -r ".private_key" <<< $key_b) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_b) \
    --public-key-external $(jq -r ".public_key" <<< $key_a) \
    --input working/server_b/raw/data.ndjson \
    --input-internal working/server_b/intermediate/internal/verify2/data.ndjson \
    --input-external working/server_b/intermediate/external/verify2/data.ndjson \
    --output working/server_b/intermediate/internal/aggregate/ \

jq -c '.' working/server_b/intermediate/internal/verify2/data.ndjson

cp \
    working/server_b/intermediate/internal/aggregate/data.ndjson \
    working/server_a/intermediate/external/aggregate/

###########################################################
# publish
###########################################################

python -m prio publish \
    --n-data 3 \
    --batch-id test \
    --server-id A \
    --private-key $(jq -r ".private_key" <<< $key_a) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_a) \
    --public-key-external $(jq -r ".public_key" <<< $key_b) \
    --input-internal working/server_a/intermediate/internal/aggregate/data.ndjson \
    --input-external working/server_a/intermediate/external/aggregate/data.ndjson \
    --output working/server_a/processed/

jq -c '.' working/server_a/processed/data.ndjson

python -m prio publish \
    --n-data 3 \
    --batch-id test \
    --server-id B \
    --private-key $(jq -r ".private_key" <<< $key_b) \
    --shared-secret $shared \
    --public-key-internal $(jq -r ".public_key" <<< $key_b) \
    --public-key-external $(jq -r ".public_key" <<< $key_a) \
    --input-internal working/server_b/intermediate/internal/aggregate/data.ndjson \
    --input-external working/server_b/intermediate/external/aggregate/data.ndjson \
    --output working/server_b/processed/

jq -c '.' working/server_b/processed/data.ndjson
